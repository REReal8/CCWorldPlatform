local t_projects = {}

local corelog = require "corelog"

local Callback = require "obj_callback"
local ModuleRegistry = require "module_registry"
local moduleRegistry = ModuleRegistry:getInstance()

local Host = require "obj_host"

local TestObj = require "test.obj_test"

local enterprise_projects = require "enterprise_projects"

function t_projects.T_All()
    t_projects.T_AreAllTrue_QSrv()
    t_projects.T_DeleteProjects()
    t_projects.T_StartProject_ASrv()
end

function t_projects.T_AreAllTrue_QSrv()
    -- prepare test
    corelog.WriteToLog("* enterprise_projects.AreAllTrue_QSrv() tests")
    local serviceData = {
        booleanArg1 = true,
        booleanArg2 = true,
        booleanArg3 = true,
        booleanArg4 = true,
    }

    -- test all boolean true
    local result = enterprise_projects.AreAllTrue_QSrv(serviceData)
    local expectedSuccess = true
    assert(result.success, "gotten AreAllTrue_QSrv(="..tostring(result.success)..") not the same as expected(="..tostring(expectedSuccess)..")")

    -- test ignore none boolean arguments
    serviceData.noneBooleanArg1 = "none boolean Arg1"
    serviceData.noneBooleanArg2 = "none boolean Arg2"
    result = enterprise_projects.AreAllTrue_QSrv(serviceData)
    expectedSuccess = true
    assert(result.success, "gotten AreAllTrue_QSrv(="..tostring(result.success)..") not the same as expected(="..tostring(expectedSuccess)..")")

    -- test one boolean false
    serviceData.booleanArg3 = false
    result = enterprise_projects.AreAllTrue_QSrv(serviceData)
    expectedSuccess = false
    assert(not result.success, "gotten AreAllTrue_QSrv(="..tostring(result.success)..") not the same as expected(="..tostring(expectedSuccess)..")")
    serviceData.booleanArg3 = true

    -- cleanup test
end

local callbackTestValue = "some callback data"
local testArgValue20 = 20
local testArgValue222 = 222
local testArgValue44 = 44
local testObj = TestObj:new({
    _field1 = "field1",
    _field2 = 4,
})

local compact = { compact = true }

-- voorstel ter generalsatie van huidige projectDef in T_StartProject_ASrv hieronder:
local voorstelNieuwProjectDef = {
    stepType = "Seq", stepDataDef = {
        { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
        }},
        { stepType = "ASrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_ASrv" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
        }},
        { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testTableSource.key3.nKey2" },
        }},
        { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testTable4" },
            { keyDef = "testArg.field4" , sourceStep = 0, sourceKeyDef = "testTableSource2.key4" },
        }},
        -- en een mogelijke nested Seq stap:
        { stepType = "Seq", stepDataDef = {
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- ... etc
            }, stepReturnDef  = {
                { keyDef = "testBArg0"          , sourceStep = 0, sourceKeyDef = "testArgSource" },
                { keyDef = "testBArg1"          , sourceStep = 1, sourceKeyDef = "input" },
                -- etc
            }
        },
        -- en een mogelijke nested Par stap:
        { stepType = "Par", stepDataDef = {
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }}, -- ... etc
            }, stepReturnDef  = {
                { keyDef = "testBArg0"          , sourceStep = 0, sourceKeyDef = "testArgSource" },
                -- etc
            }
        },
        { stepType = "SOSrv", stepTypeDef = { className = "TestObj", serviceName = "Test_SOSrv", objStep = 0, objKeyDef = "testObj" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
        }},
        { stepType = "AOSrv", stepTypeDef = { className = "TestObj", serviceName = "Test_AOSrv", objStep = 0, objKeyDef = "testObj" }, stepDataDef = {
            { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
        }},
    },
    stepReturnDef  = {
        { keyDef = "testBArg0"          , sourceStep = 0, sourceKeyDef = "testArgSource" },
        { keyDef = "testBArg1"          , sourceStep = 1, sourceKeyDef = "input" },
        { keyDef = "testBArg2"          , sourceStep = 2, sourceKeyDef = "input" },
        { keyDef = "testBArg3"          , sourceStep = 3, sourceKeyDef = "input" },
        { keyDef = "testBArg4"          , sourceStep = 4, sourceKeyDef = "input" },
        { keyDef = "testBArgS"          , sourceStep = 5, sourceKeyDef = "input" },
        { keyDef = "testObjSelfS"       , sourceStep = 5, sourceKeyDef = "selfObj" },
        { keyDef = "testBArgA"          , sourceStep = 6, sourceKeyDef = "input" },
        { keyDef = "testObjSelfA"       , sourceStep = 6, sourceKeyDef = "selfObj" },
    }
}

function t_projects.T_StartProject_ASrv()
    -- prepare test
    corelog.WriteToLog("* enterprise_projects.StartProject_ASrv() tests")
    local hostName = "TestHost"
    local host = Host:new({
        _hostName   = hostName,
    })
    moduleRegistry:registerModule(hostName, host)
    local objLocator = host:saveObject(testObj)

    local projectDef = {
        steps   = {
            -- test SSrv
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- test ASrv
            { stepType = "ASrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_ASrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- test indexed source KeyDef
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testTableSource.key3.nKey2" },
            }},
            -- test indexed output and source KeyDef
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_test", serviceName = "Test_SSrv" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testTable4" },
                { keyDef = "testArg.field4" , sourceStep = 0, sourceKeyDef = "testTableSource2.key4" },
            }},
            -- test SOSrv
            { stepType = "SOSrv", stepTypeDef = { className = "TestObj", serviceName = "Test_SOSrv", objStep = 0, objKeyDef = "testObj" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- test AOSrv
            { stepType = "AOSrv", stepTypeDef = { className = "TestObj", serviceName = "Test_AOSrv", objStep = 0, objKeyDef = "testObj" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- test located AOSrv
            { stepType = "LAOSrv", stepTypeDef = { serviceName = "Test_AOSrv", locatorStep = 0, locatorKeyDef = "objLocator" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            -- test located SMtd
            { stepType = "LSMtd", stepTypeDef = { methodName = "getTestArg", locatorStep = 0, locatorKeyDef = "objLocator" }, stepDataDef = {
                { keyDef = "testArg"        , sourceStep = 0, sourceKeyDef = "testArgSource" },
            }},
            { stepType = "SSrv", stepTypeDef = { moduleName = "enterprise_projects", serviceName = "AreAllTrue_QSrv" }, stepDataDef = {
                { keyDef = "success1"       , sourceStep = 1, sourceKeyDef = "success" },
                { keyDef = "success2"       , sourceStep = 2, sourceKeyDef = "success" },
                { keyDef = "success3"       , sourceStep = 3, sourceKeyDef = "success" },
                { keyDef = "success4"       , sourceStep = 4, sourceKeyDef = "success" },
                { keyDef = "success5"       , sourceStep = 5, sourceKeyDef = "success" },
                { keyDef = "success6"       , sourceStep = 6, sourceKeyDef = "success" },
                { keyDef = "success7"       , sourceStep = 7, sourceKeyDef = "success" },
                { keyDef = "success8"       , sourceStep = 8, sourceKeyDef = "success" },
            }},
        },
        returnData  = {
            { keyDef = "testBArg0"          , sourceStep = 0, sourceKeyDef = "testArgSource" },
            { keyDef = "testBArg1"          , sourceStep = 1, sourceKeyDef = "input" },
            { keyDef = "testBArg2"          , sourceStep = 2, sourceKeyDef = "input" },
            { keyDef = "testBArg3"          , sourceStep = 3, sourceKeyDef = "input" },
            { keyDef = "testBArg4"          , sourceStep = 4, sourceKeyDef = "input" },
            { keyDef = "testBArgS"          , sourceStep = 5, sourceKeyDef = "input" },
            { keyDef = "testObjSelfS"       , sourceStep = 5, sourceKeyDef = "selfObj" },
            { keyDef = "testBArgA"          , sourceStep = 6, sourceKeyDef = "input" },
            { keyDef = "testObjSelfA"       , sourceStep = 6, sourceKeyDef = "selfObj" },
            { keyDef = "testBArgLA"         , sourceStep = 7, sourceKeyDef = "input" },
            { keyDef = "testObjSelfLA"      , sourceStep = 7, sourceKeyDef = "selfObj" },
            { keyDef = "success"            , sourceStep = 9, sourceKeyDef = "success" },
        }
    }
    local projectData = {
        testArgSource = testArgValue20,
        testTableSource = {
            key1 = 11,
            key2 = 22,
            key3 = {
                nKey1 = 111,
                nKey2 = testArgValue222,
                nKey3 = 333,
            }
        },
        testTableSource2 = {
            key4 = testArgValue44,
            key5 = 55,
        },
        testTable4 = { },
        testObj = testObj,
        objLocator = objLocator,
    }
    local callback = Callback:new({
        _moduleName     = "t_projects",
        _methodName     = "StartProject_ASrv_Callback",
        _data           = {
            [0]             = callbackTestValue,
            ["hostName"]    = hostName,
            ["objLocator"]  = objLocator,
        },
    })
    local projectServiceData = {
        projectDef  = projectDef,
        projectData = projectData,
    }

    -- test
    return enterprise_projects.StartProject_ASrv(projectServiceData, callback)
end

function t_projects.StartProject_ASrv_Callback(callbackData, serviceResults)
    -- test (cont)
    assert(serviceResults.success, "failed executing async service")
    local callbackValue = callbackData[0]
    local expectedCallbackValue = callbackTestValue
    assert(callbackValue == expectedCallbackValue, "gotten callbackValue(="..(callbackValue or "nil")..") not the same as expected(="..expectedCallbackValue..")")

    -- test input projectData is returned
    local testBArg = serviceResults.testBArg0
    local expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")

    -- test SSrv (results)
    testBArg = serviceResults.testBArg1
    expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")

    -- test ASrv (results)
    testBArg = serviceResults.testBArg2
    expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")

    -- test indexed sourceKey Def (results)
    testBArg = serviceResults.testBArg3
    expectedTestBArg = testArgValue222
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")

    -- test indexed output and source KeyDef (results)
    testBArg = serviceResults.testBArg4.field4
    expectedTestBArg = testArgValue44
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")

    -- test SOSrv (results)
    testBArg = serviceResults.testBArgS
    expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")
    local testObjSelf = serviceResults.testObjSelfS
    testObjSelf = TestObj:new(testObjSelf)
    assert(TestObj.IsOfType(testObjSelf), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not of type TestObj")
    assert(testObjSelf:isSame(testObj), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not the same as expected(="..textutils.serialise(testObj, compact )..")")

    -- test AOSrv (results)
    testBArg = serviceResults.testBArgA
    expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")
    testObjSelf = serviceResults.testObjSelfA
    testObjSelf = TestObj:new(testObjSelf)
    assert(TestObj.IsOfType(testObjSelf), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not of type TestObj")
    assert(testObjSelf:isSame(testObj), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not the same as expected(="..textutils.serialise(testObj, compact )..")")

    -- test located AOSrv (results)
    testBArg = serviceResults.testBArgLA
    expectedTestBArg = testArgValue20
    assert(testBArg == expectedTestBArg, "gotten testBArg(="..testBArg..") not the same as expected(="..expectedTestBArg..")")
    testObjSelf = serviceResults.testObjSelfLA
    testObjSelf = TestObj:new(testObjSelf)
    assert(TestObj.IsOfType(testObjSelf), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not of type TestObj")
    assert(testObjSelf:isSame(testObj), "gotten testObjSelf(="..textutils.serialise(testObjSelf, compact )..") not the same as expected(="..textutils.serialise(testObj, compact )..")")

    -- cleanup test
    local objLocator = callbackData["objLocator"]
    local hostName = callbackData["hostName"]
    local host = Host.GetHost(hostName) if not host then corelog.Error("host not found") return end
    host:deleteResource(objLocator)
    moduleRegistry:delistModule(hostName)
end

function t_projects.T_DeleteProjects()
    -- prepare test
    corelog.WriteToLog("* enterprise_projects.DeleteProjects() test")

    -- test
    enterprise_projects.DeleteProjects()
    local nProjects = enterprise_projects.GetNumberOfProjects_Att()
    local expectedNProjects = 0
    assert(nProjects == expectedNProjects, "gotten nProjects(="..nProjects..") not the same as expected(="..expectedNProjects..")")

    -- cleanup test
end

return t_projects
