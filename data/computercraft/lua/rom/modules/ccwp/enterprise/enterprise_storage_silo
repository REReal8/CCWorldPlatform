local enterprise_storage_silo = {}
local corelog = require "corelog"
local coredht = require "coredht"

local InputChecker = require "input_checker"
local Callback = require "obj_callback"
local TaskCall = require "obj_task_call"

local Location = require "obj_location"
local Block = require "obj_block"
local LayerRectangle = require "obj_layer_rectangle"

local enterprise_assignmentboard = require "enterprise_assignmentboard"
local enterprise_construction = require "enterprise_construction"

local db = {
    dhtRoot     = "enterprise_storage",
    dhtSites    = "sites",
}

-- ToDo: consider renaming to enterprise_silo

function StoreItems(site, itemList)
    -- just loop all top chests, ignore the itemList (for now)
    for i, topChest in ipairs(site.topChests) do

        -- this one free?
        if topChest.status == "free" then

            -- save this to the dht
            coredht.SaveData("used", db.dhtRoot, db.dhtSites, site.sitesIndex, "topChests", i, "status")

            -- return the location of this top chest
            return topChest.location
        end
    end
end

function ItemsDelivered(sitesIndex, topChestIndex, itemList, location)
    -- variables
    local callback = Callback:new({
        _moduleName     = "enterprise_assignmentboard",
        _methodName     = "Dummy_Callback",
        _data           = { },
    })
    local assignmentMeta        = {
        startTime       = 0,
        location        = location:copy(),
        needTool        = false,
        needTurtle      = true,
        fuelNeeded      = 100
    }
    local assignmentArguments   = {
        sitesIndex      = sitesIndex,
        topChestIndex   = topChestIndex
    }

    -- now we need to get some work done, time for a new assignment
    local assignmentServiceData = {
        metaData    = assignmentMeta,
        taskCall    = TaskCall:new({ _moduleName = "role_storage_silo_worker", _methodName = "ItemsDelivered_Task", _data = assignmentArguments, }),
    }
    return enterprise_assignmentboard.DoAssignment_ASrv(assignmentServiceData, callback)
end

function ItemPresent(site, itemName)
    -- variables
    local itemCount = 0

    -- loop all storage chests
    for i, storageChests in ipairs(site.storageChests) do

        -- right item?
        if storageChests.itemName == itemName then

            -- update the counter with the actual value || virual might be smarter though
            itemCount = itemCount + storageChests.actual
        end
    end

    -- done
    return itemCount
end

function RetrieveItems(sitesIndex, itemList, callback, callbackArgs)

    -- variables
    local site      = coredht.GetData(db.dhtRoot, db.dhtSites, sitesIndex)
    local location  = nil

    -- part 1: make a reservation for a pick up box
    -- just loop all top chests, ignore the itemList (for now)
    for i, topChest in ipairs(site.topChests) do

        -- this one free?
        if topChest.status == "free" then

            -- save this to the dht
            coredht.SaveData("used", db.dhtRoot, db.dhtSites, site.sitesIndex, "topChests", i, "status")

            -- return the location of this top chest
            location = topChest.location

            -- done with the loop
            break
        end
    end

    -- found any?
    if location == nil then corelog.Error("enterprise_storage_silo.RetrieveItems: no free top chest") return nil end

    -- part 2: make an assignment for the actual pickup
    local assignmentMeta        = {
        startTime       = 0,
        location        = site.entryLocation:copy(),
        needTool        = false,
        needTurtle      = true,
        fuelNeeded      = 100
    }
    local assignmentArguments   = {
        sitesIndex      = sitesIndex,
        itemList        = itemList,
        dropLocation    = location:copy(),
    }

    -- now we need to get some work done, time for a new assignment
    local assignmentServiceData = {
        metaData    = assignmentMeta,
        taskCall    = TaskCall:new({ _moduleName = "role_storage_silo_worker", _methodName = "RetrieveItems_Task", _data = assignmentArguments, }),
    }
    enterprise_assignmentboard.DoAssignment_ASrv(assignmentServiceData, callback, callbackArgs)

    -- return the location of the pickup box
    return location -- ToDo: investigate if is it okay that this location is returned sync in an async function
end

function ItemsCollected(site, topChest)
    -- mark the topchest free, that's all
    coredht.SaveData("free", db.dhtRoot, db.dhtSites, site.sitesIndex, "topChests", topChest.chestIndex, "status")
end

local function TopL0_layer()
    return LayerRectangle:new({
        _codeArray  = {
            ["T"]   = Block:new({ _name = "minecraft:torch" }),
            ["C"]   = Block:new({ _name = "minecraft:chest", _dx =0, _dy = 1 }),
            [" "]   = Block:new({ _name = Block.NoneBlockName() }),
        },
        _codeMap    = {
            [6] = "  C C ",
            [5] = "      ",
            [4] = "T     ",
            [3] = "      ",
            [2] = "      ",
            [1] = "   T  ",
        },
    })
end

local function Shaft_layer()
    return LayerRectangle:new({
        _codeArray  = {
            [" "]   = Block:new({ _name = Block.NoneBlockName() }),
        },
        _codeMap    = {
            [1] = " ",
        },
    })
end

local function Chest_layer()
    return LayerRectangle:new({
        _codeArray  = {
            ["C"]   = Block:new({ _name = "minecraft:chest", _dx =-1, _dy = 0 }),
            ["D"]   = Block:new({ _name = "minecraft:chest", _dx = 0, _dy = 1 }),
            ["E"]   = Block:new({ _name = "minecraft:chest", _dx = 0, _dy =-1 }),
            ["F"]   = Block:new({ _name = "minecraft:chest", _dx = 1, _dy = 0 }),
            [" "]   = Block:new({ _name = Block.NoneBlockName() }),
        },
        _codeMap    = {
            [3] = "DDF",
            [2] = "C F",
            [1] = "CEE",
        },
    })
end

local function GetSiloL0_blueprint(siteData)
    -- construct layer list
    if siteData.topChests ~= 2 then corelog.Warning("enterprise_storage_silo.GetSiloL0_blueprint: Not yet implemented for other (="..siteData.topChests..") than 2 top chests") end
    local layerList = {
        { startpoint = Location:new({ _x= 0, _y= 0, _z=  0}), buildFromAbove = true, layer = TopL0_layer()}, -- ToDo: use siteData.topChests
        { startpoint = Location:new({ _x= 3, _y= 3, _z= -1}), buildFromAbove = false, layer = Shaft_layer()},
    }
    for i=1, siteData.layers, 1 do
        table.insert(layerList, { startpoint = Location:new({ _x= 2, _y= 2, _z= -1-i}), buildFromAbove = false, layer = Chest_layer()})
    end

    -- construct blueprint
    local blueprint = {
        layerList = layerList,
        escapeSequence = {
            Location:new({ _x= 3, _y= 3, _z=  1}),
        }
    }

    return blueprint
end

function enterprise_storage_silo.BuildNewSite_ASrv(...)
    -- get & check input from description
    local checkSuccess, siteData, location, materialsHostLocator, callback = InputChecker.Check([[
        This public function (service) builds a new silo.

        Return value:
                                        - (boolean) whether the service was scheduled successfully

        Parameters:
            siteData                    + (table) data about this silo, like type and layout
                location                + (Location) location to build
                materialsHostLocator    + (URL) locating the host of the building materials
            callback                    + (Callback) to call once service is ready
    ]], table.unpack(arg))
    if not checkSuccess then corelog.Error("enterprise_storage_silo.BuildNewSite_ASrv: Invalid input") return Callback.ErrorCall(callback) end

    -- let construction enterprise build the silo
    local blueprintBuildData = {
        blueprintStartpoint     = location:copy(),
        blueprint               = GetSiloL0_blueprint(siteData),
        materialsHostLocator    = materialsHostLocator,
    }
    corelog.WriteToLog(">Building silo at "..textutils.serialise(blueprintBuildData.blueprintStartpoint, { compact = true }))
    return enterprise_construction.BuildBlueprint_ASrv(blueprintBuildData, callback)
end

function FindSiteByTopChest(site, location)
--[[
    This function checks of this site has a topchest which matches the given location. Returns nil if not found
--]]

    -- loop our top chests
    for i, topChest in ipairs(site.topChests) do

        -- this the one?
        if location:isSame(topChest.location) then return topChest end
    end

    -- still here? Then we have found no match
    return nil
end

function CheckIntegrity(site)
    local callback = Callback:new({
        _moduleName     = "enterprise_assignmentboard",
        _methodName     = "Dummy_Callback",
        _data           = { },
    })

    -- meta about the assignment, for the selection procedure
    local assignmentMeta        = {
        startTime       = 0,
        location        = site.entryLocation:copy(),
        needTool        = false,
        needTurtle      = true,
        fuelNeeded      = 100
    }

    -- arguments for the assignment itself
    local assignmentArguments   = {
        sitesIndex      = site.sitesIndex,
    }

    -- now we need to get some work done, time for a new assignment
    local assignmentServiceData = {
        metaData    = assignmentMeta,
        taskCall    = TaskCall:new({ _moduleName = "role_storage_silo_worker", _methodName = "CheckIntegrity_Task", _data = assignmentArguments, }),
    }
    return enterprise_assignmentboard.DoAssignment_ASrv(assignmentServiceData, callback)
end

--    _           _ _     _               _   _                                 _     _                       _       _
--   | |         (_) |   | |             | | | |                        ___    | |   | |                     (_)     | |
--   | |__  _   _ _| | __| |  _ __   __ _| |_| |_ ___ _ __ _ __  ___   ( _ )   | |__ | |_   _  ___ _ __  _ __ _ _ __ | |_ ___
--   | '_ \| | | | | |/ _` | | '_ \ / _` | __| __/ _ \ '__| '_ \/ __|  / _ \/\ | '_ \| | | | |/ _ \ '_ \| '__| | '_ \| __/ __|
--   | |_) | |_| | | | (_| | | |_) | (_| | |_| ||  __/ |  | | | \__ \ | (_>  < | |_) | | |_| |  __/ |_) | |  | | | | | |_\__ \
--   |_.__/ \__,_|_|_|\__,_| | .__/ \__,_|\__|\__\___|_|  |_| |_|___/  \___/\/ |_.__/|_|\__,_|\___| .__/|_|  |_|_| |_|\__|___/
--                           | |                                                                  | |
--                           |_|                                                                  |_|

return enterprise_storage_silo
