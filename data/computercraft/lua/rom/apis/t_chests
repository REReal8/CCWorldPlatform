local queryPartURI = "?minecraft:birch_log=1&minecraft:torch=5"

local callbackFunction = "t_main.Func1_Callback"
local callbackData = {"some callback data"}

function T_DeleteChests()
    enterprise_chests.DeleteChests()
end

function T_RegisterAndUpdateChest()
    corelog.WriteToLog("* Test Register and Update chest")

    -- create project definition
    local testProject = {
        services    = {
            { serviceName = "enterprise_chests.RegisterChest", async = false, input = {
                { keyName = "location"          , valueSource = 0, sourceKey = "chestLocation" },
                { keyName = "accessDirection"   , valueSource = 0, sourceKey = "chestAccessDirection" },
            }},
            { serviceName = "enterprise_chests.UpdateChestRecord", async = true, input = {
                { keyName = "id"                , valueSource = 1, sourceKey = "id" },
            }},
            { serviceName = "enterprise_projects.AllTrue", async = false, input = {
                { keyName = "success1"          , valueSource = 1, sourceKey = "success" },
                { keyName = "success2"          , valueSource = 2, sourceKey = "success" },
            }},
        },
        returnData  = {
            { keyName = "success", valueSource = 3, sourceKey = "success" },
        }
    }
    local projectData = {
        chestLocation        = {x= 16, y= 17, z= 1, dx=0, dy=1},
        chestAccessDirection = "back"
    }

    -- start test project
    enterprise_projects.StartProject(testProject, projectData, callbackFunction, callbackData)
end

local chest1Id = nil

function T_UpdateChestRecord1()
    corelog.WriteToLog("* Test UpdateChestRecord 1")
    -- create chest data
    local chestIdData  = {
        id = chest1Id
    }

    -- call test method
    corelog.WriteToLog("  calling enterprise_chests.UpdateChestRecord("..textutils.serialize(chestIdData)..")")
    local result = enterprise_chests.UpdateChestRecord(chestIdData, callbackFunction, callbackData)
    corelog.WriteToLog("  result="..textutils.serialize(result))
end

function T_RegisterChest1()
    corelog.WriteToLog("* Test RegisterChest 1:")
    -- create chest data
    local chestData  = {
        location        = {x= 14, y= 17, z= 1, dx=0, dy=1},
        accessDirection = "top"
    }

    -- call test method
    corelog.WriteToLog("  calling enterprise_chests.RegisterChest("..textutils.serialize(chestData)..")")
    local result = enterprise_chests.RegisterChest(chestData, callbackFunction, callbackData)
    corelog.WriteToLog("  result="..textutils.serialize(result))
    if result.success then
        chest1Id = result.id
    end
end

function T_DelistChests()
    corelog.WriteToLog("* Test DelistChests 1:")
    -- create chest data 1
    local chestData1  = {
        id = chest1Id
    }

    -- call test method
    corelog.WriteToLog("  calling enterprise_chests.DelistChest("..textutils.serialize(chestData1)..")")
    enterprise_chests.DelistChest(chestData1, callbackFunction, callbackData)
end

function T_GetItemsIntoTurtle()
    corelog.WriteToLog("* Test GetItemsIntoTurtle for chests:")
    -- create transferData
    local sourceURL = enterprise_chests.GetChestURL(chest1Id)
    sourceURL:setQueryURI(queryPartURI)
    local transferData = {
        sourceURL =  sourceURL,
    }

    -- call test method
    corelog.WriteToLog("  calling enterprise_chests.GetItemsIntoTurtle("..textutils.serialize(transferData)..","..callbackFunction..","..textutils.serialize(callbackData)..")")
    enterprise_chests.GetItemsIntoTurtle(transferData, callbackFunction, callbackData)
end

function T_ItemsAvailableVia()
    corelog.WriteToLog("* Test ItemsAvailableVia for chest:")
    -- create transferData
    local queryURL = enterprise_chests.GetChestURL(chest1Id)
    queryURL:setQueryURI(queryPartURI)
    local queryData = {
        itemQueryURL = queryURL,
    }

    -- call test method
    corelog.WriteToLog("  calling enterprise_chests.ItemsAvailableVia("..textutils.serialize(queryData)..")")
    local result = enterprise_chests.ItemsAvailableVia(queryData)
    corelog.WriteToLog("  result="..textutils.serialize(result))
end
