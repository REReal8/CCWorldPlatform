local db = {
    dhtRoot         = "enterprise_energy",
    dhtParameters   = "fuelParameters",
}

--[[
    The Energy enterprise offers services for handling energy (fuel).
--]]

--                _     _ _         __                  _   _
--               | |   | (_)       / _|                | | (_)
--    _ __  _   _| |__ | |_  ___  | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | '_ \| | | | '_ \| | |/ __| |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | |_) | |_| | |_) | | | (__  | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   | .__/ \__,_|_.__/|_|_|\___| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
--   | |
--   |_|

function ProvideFuelTo_ASrv(...)
    -- get & check input from description
    local checkSuccess, turtleId, fuelAmount, ingredientsSupplierLocator, assignmentsPriorityKey, callback, callbackData = coreutils.CheckInput([[
        This public async service provides fuel to a turtle.

        Return value:
            nil

        Async service return value (to callback):
                                            - (table)
                success                     - (boolean) whether the service executed successfully

        Parameters:
            serviceData                     - (table) data about this service
                turtleId                    + (number) id of the turtle
                fuelAmount                  + (number) fuel amount to provide to turtle
                ingredientsSupplierLocator  + (URL) locating where the fuel ingredients can be retrieved
                assignmentsPriorityKey      + (string, "") priorityKey that should be set for all assignments triggered by this service
            callback                        + (string) name of function to call once service is ready
            callbackData                    + (table) data to supply to callback function
    --]], table.unpack(arg))
    if not checkSuccess then corelog.Error("enterprise_energy.ProvideFuelTo_ASrv: Invalid input") return coreutils.DoCallback(callback, callbackData, {success = false}) end

    -- ToDo: remove?
    -- ensure enterprise has a key in the dht
    if coredht.GetData(db.dhtRoot) == nil then
        -- create the entry
        coredht.SaveData({}, db.dhtRoot)

        -- reset parameters
        ResetParameters()
    end

    -- determine fuelItemsNeed
    local fuelItemsNeed = FuelItemsForFuel(fuelAmount)

    -- (re)fuel turtle
    local refuelServiceData = {
        turtleId                    = turtleId,
        fuelItems                   = fuelItemsNeed,
        ingredientsSupplierLocator  = ingredientsSupplierLocator,
        assignmentsPriorityKey      = assignmentsPriorityKey,
    }
    corelog.WriteToLog("* Refuelling turtle(id="..turtleId..") with "..fuelAmount.." fuel *")
    Refuel_ASrv(refuelServiceData, callback, callbackData)
end

function FuelNeed_Refuel_Att()
    --[[
        enterprise_energy attribute with the current fuelNeed for refueling.
    --]]

    -- get parameters
    local parameters = GetParameters()

    -- determine fuelNeed
    local fuelNeed = 0

    -- determine fuelNeed by current forest
    local forest = enterprise_woods.GetForest()
    local forestLocation = forest.location
    local fuelNeed_Harvest = enterprise_woods.FuelNeed_Harvest_Att()
    fuelNeed = fuelNeed + fuelNeed_Harvest

    -- determine fuelNeed for 1 extra tree (to anticipate for fuelNeed in case the forest gets upgraded)
    if parameters.enterpriseLevel > 0 then
        local fuelNeed_ExtraTree = enterprise_woods.FuelNeedExtraTree_Att()
        fuelNeed = fuelNeed + fuelNeed_ExtraTree
    end

    -- check there is (already) a factory
    local aFactoryExists = enterprise_factory.NumberOfSites_Att() > 0
    if aFactoryExists then
        -- determine fuelNeed by factory
        local items = FuelItemsForFuel(1)
        local fuelNeed_Production = enterprise_factory.FuelNeed_Production_Att(items)
        fuelNeed = fuelNeed + fuelNeed_Production

        -- determine fuelNeed for traveling
        local factoryLocation = enterprise_factory.SiteLocation_Att(items)
        local fuelNeed_ForestFactoryTravel = role_fuel_worker.NeededFuelToFrom(factoryLocation, forestLocation)
        fuelNeed = fuelNeed + fuelNeed_ForestFactoryTravel
    end

    -- end
    return fuelNeed
end

function RefuelAmount_Att()
    --[[
        enterprise_energy attribute with the current refuel amount.
    --]]

    -- get parameters
    local parameters = GetParameters()
    local enterpriseLevel = parameters.enterpriseLevel
    if enterpriseLevel == 0 then
        return 60 -- 1 log = 4 planks = 60 fuel
    elseif enterpriseLevel == 1 then
        return 300 -- 1 tree = min 5 logs = 20 planks = 300 fuel
    else
        corelog.Warning("enterprise_energy.RefuelAmount_Att: not (yet) implemented for enterpriseLevel="..enterpriseLevel)
        return 999999
    end
end

function Refuel_ASrv(...)
    -- get & check input from description
    local checkSuccess, turtleId, fuelItems, ingredientsSupplierLocator, assignmentsPriorityKey, callback, callbackData = coreutils.CheckInput([[
        This public async service (re)fuels a turtle from fuelItems.

        Return value:
            nil

        Async service return value (to callback):
                                            - (table)
                success                     - (boolean) whether the service executed successfully

        Parameters:
            serviceData                     - (table) data about this service
                turtleId                    + (number) id of the turtle to fuel
                fuelItems                   + (table) with one or more items (formatted as an array of [itemName] = itemCount key-value pairs) to fuel with
                ingredientsSupplierLocator  + (URL) locating where ingredients can be retrieved
                assignmentsPriorityKey      + (string, "") priorityKey that should be set for all assignments triggered by this service
            callback                        + (string) name of function to call once service is ready
            callbackData                    + (table) data to supply to callback function
    --]], table.unpack(arg))
    if not checkSuccess then corelog.Error("enterprise_energy.Refuel_ASrv: Invalid input") return coreutils.DoCallback(callback, callbackData, {success = false}) end

    -- create project service data
    local turtleToRefuelLocator = enterprise_turtle.GetTurtleLocator_SSrv({turtleId = turtleId}).turtleLocator
    local fuelItemsLocator = ingredientsSupplierLocator:copy()
    fuelItemsLocator:setQuery(coreutils.DeepCopy(fuelItems))
--    corelog.WriteToLog("    fuelItemsLocator="..fuelItemsLocator:getURI()..".")
    local refuelTaskData = {
        turtleId    = turtleId,
        fuelItems   = coreutils.DeepCopy(fuelItems),

        priorityKey = assignmentsPriorityKey,
    }
    local buildBlueprintProjectDef = {
        steps   = {
            { stepName = "enterprise_isp.ProvideItemsTo_ASrv", async = true, stepDataDef = {
                { keyDef = "itemsLocator"               , valueSource = 0, keyDefSource = "fuelItemsLocator" },
                { keyDef = "storageLocator"             , valueSource = 0, keyDefSource = "turtleToRefuelLocator" },
                { keyDef = "ingredientsSupplierLocator" , valueSource = 0, keyDefSource = "ingredientsSupplierLocator" },
                { keyDef = "assignmentsPriorityKey"     , valueSource = 0, keyDefSource = "assignmentsPriorityKey" },
            }},
            { stepName = "enterprise_assignmentboard.DoAssignment_ASrv", async = true, stepDataDef = {
                { keyDef = "task"                       , valueSource = 0, keyDefSource = "refuel_Task" },
                { keyDef = "metaData"                   , valueSource = 0, keyDefSource = "refuelMetaData" },
                { keyDef = "taskData"                   , valueSource = 0, keyDefSource = "refuelTaskData" },
            }},
            { stepName = "enterprise_projects.AreAllTrue_QSrv", async = false, stepDataDef = {
                { keyDef = "success1"                   , valueSource = 1, keyDefSource = "success" },
                { keyDef = "success2"                   , valueSource = 2, keyDefSource = "success" },
            }},
        },
        returnData  = {
            { keyDef = "success"                    , valueSource = 3, keyDefSource = "success" },
        }
    }
    local projectData = {
        fuelItems                   = coreutils.DeepCopy(fuelItems),

        fuelItemsLocator            = fuelItemsLocator,
        turtleToRefuelLocator       = turtleToRefuelLocator,
        ingredientsSupplierLocator  = ingredientsSupplierLocator,

        refuel_Task                 = "role_fuel_worker.Refuel_Task",
        refuelMetaData              = role_fuel_worker.Refuel_MetaData(refuelTaskData),
        refuelTaskData              = refuelTaskData,

        assignmentsPriorityKey      = assignmentsPriorityKey,
    }
    local projectServiceData = {
        projectDef  = buildBlueprintProjectDef,
        projectData = projectData,
    }

    -- start project
    enterprise_projects.StartProject_ASrv(projectServiceData, callback, callbackData)
end

function GetParameters()
    return coredht.GetData(db.dhtRoot, db.dhtParameters)
end

--    _                 _    __                  _   _
--   | |               | |  / _|                | | (_)
--   | | ___   ___ __ _| | | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | |/ _ \ / __/ _` | | |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | | (_) | (_| (_| | | | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   |_|\___/ \___\__,_|_| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/

function ResetParameters()
--    corelog.WriteToLog("enterprise_energy: resetting parameters")
    coredht.SaveData({
        enterpriseLevel             = 0,

        fuelItemName                = "minecraft:birch_planks",
        fuelItemGain                = 15,
    }, db.dhtRoot, db.dhtParameters)
end

function UpdateEnterprise_SSrv(...)
    -- get & check input from description
    local checkSuccess, enterpriseLevel = coreutils.CheckInput([[
        This private sync service updates the enterprise information.

        Return value:
                                        - (table)
                success                 - (boolean) whether the service executed successfully

        Parameters:
            serviceData                 - (table) data about the service
                enterpriseLevel         + (number) with enterprise level
    --]], table.unpack(arg))
    if not checkSuccess then corelog.Error("enterprise_energy.UpdateEnterprise_SSrv: Invalid input") return {success = false} end

    -- get parameters
    local parameters = GetParameters()

    -- set enterprise information
    parameters.enterpriseLevel = enterpriseLevel

    -- save parameters
    coredht.SaveData(parameters, db.dhtRoot, db.dhtParameters)

    -- end
    corelog.WriteToLog(">Updated enterprise_energy (level="..enterpriseLevel..")")
    return {success = true}
end

function FuelItemsForFuel(fuel)
    -- get parameters
    local parameters = GetParameters()

    -- determine fuelItems
    local fuelItemGain = parameters.fuelItemGain
    local fuelItemCount = math.ceil(fuel / fuelItemGain)
    local fuelItemName = parameters.fuelItemName
    local fuelItems = { [fuelItemName] = fuelItemCount }

    -- end
--    corelog.WriteToLog("   fuelItems="..textutils.serialise(fuelItems)..")")
    return fuelItems
end
