--[[
    The Item Service Provider (ISP) is an enterprise that provides services to handle items. From the perspective of an enterprise that needs
    items to be handled acros (possibly) multiple enterprises the ISP can be seen as a single(ton) point (or hub or router) for handling 
    those items.

    The ISP provides the following services
        ItemsAvailableVia_SSrv      - providing if a set of items are available at an itemsQueryURL
        TransferItemsFromTo_ASrv    - transferring items from a sourceItemsLocator to a destinationHostLocator
        
    The ISP implements it's services by using services of Item Service Hosts (ISH's) enterprises. For an enterprise
    to be an ISH it needs to implement the following services:

        ItemsAvailableVia_SSrv      - providing if a set of items are available at the ISH.
        - ToDo consider moving this to a new type, e.g. an ItemStorage as likely not all hosts need it. Only the once that store items.

        GetItemsIntoTurtle_ASrv     - ensuring a set of items are gathered in the ISH and transferred to the inventory of a turtle.
        PutItemsFromTurtle_ASrv     - ensuring a set of items are transferred from the inventory of a turtle to the ISH.

    Furthermore it needs to implement the following additional functions
        GetHostLocator_SSrv         - provide the URL of the ISH
--]]

--                _     _ _         __                  _   _
--               | |   | (_)       / _|                | | (_)
--    _ __  _   _| |__ | |_  ___  | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | '_ \| | | | '_ \| | |/ __| |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | |_) | |_| | |_) | | | (__  | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   | .__/ \__,_|_.__/|_|_|\___| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
--   | |
--   |_|

function ItemsAvailableVia_SSrv(queryData)
    --[[
        This sync public service queries an ISH for the availability of items. The ISH and query are specified by the "base" (i.e. "ccwprp://host:port/path")
        and "query" component (i.e. `?itemName=itemCount`) of an URL.

        This service is implemented using the following underlying ISH services
            ItemsAvailableVia_SSrv

        Return value:
                                    - (table)
                success             - (boolean) whether all the queried items are available via the URL

        Parameters:
            queryData               - (table) data about the query
                itemsLocator        - (URL) locating items which availability is queried
                                        (the "base" component of the URL specifies the ISH to query)
                                        (the "query" component of the URL specifies the items to query for)
    --]]

    -- check input
    if type(queryData) ~= "table" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid queryData") return {success = false} end
    local itemsLocator = queryData.itemsLocator
    if type(itemsLocator) ~= "table" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid itemsLocator") return {success = false} end

    -- get ISH
--    corelog.WriteToLog("enterprise_isp: itemsLocator = "..textutils.serialize(itemsLocator))
    local host = itemsLocator:getHost()
    if type(host) ~= "string" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid host") return {success = false} end
--    corelog.WriteToLog("enterprise_isp: host = "..host)

    -- relay to ISH service
    if host == "turtle" then
        return enterprise_turtle.ItemsAvailableVia_SSrv(queryData)
    elseif host == "chests" then
        return enterprise_chests.ItemsAvailableVia_SSrv(queryData)
    else
        corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Not implemented for "..host .." ISH.") return {success = false}
    end
end

function TransferItemsFromTo_ASrv(transferData, callback, callbackData)
    --[[
        This async public service relays the transfer of items from an item source to a destination host.

        This service is implemented using the following underlying ISH services
            GetItemsIntoTurtle_ASrv
            PutItemsFromTurtle_ASrv

        Return value:
            nil 

        Async service return value (to callback):
                                        - (table)
                success                 - (boolean) whether the service was executed succesfully
                destinationItemsLocator - (URL) stating the final ISH and the items that where transferred to it
                                            (upon service succes the "host" component of this URL should be equal to destinationHostLocator, and
                                            the "query" should be equal to the "query" component of the sourceItemsLocator)

        Parameters:
            transferData                - (table) data about the transfer
                sourceItemsLocator      - (URL) locating the items that need transfer
                                            (the "query" component of the URL specifies the items to be transferred)
                                            (the "host" component of the URL specifies the host where the items are located)
                destinationHostLocator  - (URL) locating where (i.e. to which ISH) the items need to be transferred to
            callback                    - (string) name of function to call once service is ready
            callbackData                - (table) data to supply to callback function            
    --]]

    -- check input
    if type(transferData) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid transferData") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local sourceItemsLocator = url.URLClass:new(transferData.sourceItemsLocator)
    if type(sourceItemsLocator) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid sourceItemsLocator") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local destinationHostLocator = url.URLClass:new(transferData.destinationHostLocator)
    if type(destinationHostLocator) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid destinationHostLocator") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    if type(callback) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid callback function.") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    callbackData = callbackData or {}

    -- determine source enterprise name
    local sourceHost = sourceItemsLocator:getHost()
    if type(sourceHost) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: sourceHost of wrong type = "..type(sourceHost)..".") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local sourceEnterprise = nil
    if sourceHost == "turtle" then
        sourceEnterprise = "enterprise_turtle"
    elseif sourceHost == "chests" then
        sourceEnterprise = "enterprise_chests"
    elseif sourceHost == "shop" then
        sourceEnterprise = "enterprise_shop"
    else
        corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Not implemented for "..sourceHost .." source ISH.") return coreutils.DoCallback(callback, callbackData, {success = false})
    end

    -- determine destination enterprise name
    local destinationHost = destinationHostLocator:getHost()
    if type(destinationHost) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: destinationHost of wrong type = "..type(destinationHost)..".") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local destinationEnterprise = nil
    if destinationHost == "turtle" then
        destinationEnterprise = "enterprise_turtle"
    elseif destinationHost == "chests" then
        destinationEnterprise = "enterprise_chests"
    elseif destinationHost == "shop" then
        destinationEnterprise = "enterprise_shop"
    else
        corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Not implemented for "..destinationHost .." destination ISH.") return coreutils.DoCallback(callback, callbackData, {success = false})
    end

    -- check there are actual items to transfer
    local transferItems = sourceItemsLocator:getQuery()
    if next(transferItems) == nil then
        corelog.Warning("enterprise_isp.TransferItemsFromTo_ASrv: There are 0 items to transfer (from "..sourceItemsLocator:getURI().." to "..destinationHostLocator:getURI()..").")
        return coreutils.DoCallback(callback, callbackData, {
            success                 = true,
            destinationItemsLocator = destinationHostLocator:copy()
        })
    end

    -- create project definition
    local transferItemsProjectDef = {
        steps   = {
            { stepName = sourceEnterprise..".GetItemsIntoTurtle_ASrv", async = true, stepDataDef = {
                { keyDef = "sourceItemsLocator"         , valueSource = 0, keyDefSource = "sourceItemsLocator" },
            }},
            { stepName = destinationEnterprise..".PutItemsFromTurtle_ASrv", async = true, stepDataDef = {
                { keyDef = "turtleItemsLocator"         , valueSource = 1, keyDefSource = "turtleItemsLocator" },
                { keyDef = "destinationHostLocator"     , valueSource = 0, keyDefSource = "destinationHostLocator" },
            }},
            { stepName = "enterprise_projects.AreAllTrue_QSrv", async = false, stepDataDef = {
                { keyDef = "success1"                   , valueSource = 1, keyDefSource = "success" },
                { keyDef = "success2"                   , valueSource = 2, keyDefSource = "success" },
            }},
        },
        returnData  = {
            { keyDef = "success"                        , valueSource = 3, keyDefSource = "success" },
            { keyDef = "destinationItemsLocator"        , valueSource = 2, keyDefSource = "destinationItemsLocator" },
        }
    }
    local projectData = {
        sourceItemsLocator      = sourceItemsLocator,
        destinationHostLocator  = destinationHostLocator,
    }
    local projectServiceData = {
        projectDef  = transferItemsProjectDef,
        projectData = projectData,
    }

    -- start project
--    corelog.WriteToLog(">Transferring items from "..sourceItemsLocator:getURI().." to "..destinationHostLocator:getURI()..".")
    enterprise_projects.StartProject_ASrv(projectServiceData, callback, callbackData)

    -- end
    return nil
end

function AddItemsLocators_SSrv(serviceData)
    --[[
        This sync public service adds the items of multiple itemsLocators into one itemsLocator. The itemsLocators should have the same host/ base component.
        
        Return value:
                                    - (table)
                success             - (boolean) whether all the queried items are available via the URL
                itemsLocator        - (URL) locating all items

        Parameters:
            queryData               - (table) data about the query
                itemsLocator1       - (URL) a itemsLocator locating items
                                        (the "base" component of the URL specifies the ISH to query)
                                        (the "query" component of the URL specifies the items to query for)
                [itemsLocator2]     - (URL) another itemsLocator locating items
                [itemsLocatorN]     - (URL) and the final itemsLocator locating items
    --]]

    -- check input
    if type(serviceData) ~= "table" then corelog.Error("enterprise_isp.AddItemsLocators_SSrv: Invalid queryData") return {success = false} end

--    local itemsLocator = queryData.itemsLocator
--    if type(itemsLocator) ~= "table" then corelog.Error("enterprise_isp.AddItemsLocators_SSrv: Invalid itemsLocator") return {success = false} end

    -- use remaining input
    local allTrue = true
    local resultItemsLocator = nil
    for fieldKey, fieldvalue in pairs(serviceData) do
        -- check if it's a URL
        if type(fieldvalue) == "table" then
            -- wrap into URL
            local fieldItemsLocator = url.URLClass:new(fieldvalue)

            -- check if first
            if resultItemsLocator == nil then
                -- copy first
                resultItemsLocator = fieldItemsLocator:copy()
            else
                -- check if same host/ base as resultItemsLocator so far
                if not fieldItemsLocator:sameBase(resultItemsLocator) then 
                    corelog.Error("enterprise_isp.AddItemsLocators_SSrv: Adding itemsLocator's (resultItemsLocator="..resultItemsLocator:getURI()..", fieldItemsLocator="..fieldItemsLocator:getURI()..") with different base not supported")
                    return {success = false}
                end

                -- add query component's
                local resultItemQuery = resultItemsLocator:getQuery()
                for itemName, itemCount in pairs(fieldItemsLocator:getQuery()) do
                    resultItemQuery[itemName] = (resultItemQuery[itemName] or 0) + itemCount
                end
            end
        end
    end
    if resultItemsLocator == nil then corelog.Error("enterprise_isp.AddItemsLocators_SSrv: Couldn't construct combined itemsLocator") return {success = false} end

    -- end
    local result = {
        success = allTrue,
        itemsLocator = resultItemsLocator
    } 
    return result
end

--    _                 _    __                  _   _
--   | |               | |  / _|                | | (_)
--   | | ___   ___ __ _| | | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | |/ _ \ / __/ _` | | |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | | (_) | (_| (_| | | | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   |_|\___/ \___\__,_|_| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
