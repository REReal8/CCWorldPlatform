--[[
    The Item Service Provider (ISP) is an enterprise that provides services to handle items. From the perspective of an enterprise that needs
    items to be handled acros (possibly) multiple enterprises the ISP can be seen as a single(ton) entry point (or hub or router) for handling 
    those items.

    The ISP provides the following services
        ItemsAvailableVia_SSrv      - providing if a set of items are available at an itemQueryURL
        TransferItemsFromTo_ASrv    - transferring items from a sourceItemsLocator to a destinationHostLocator
        
    The ISP implements it's services by using services of Item Service Hosts (ISH's). Typically an ISH is another enterprise. For an enterprise
    to be an ISH it needs to implement the following services:

        ItemsAvailableVia_SSrv      - providing if a set of items are available at the ISH.
        GetItemsIntoTurtle_ASrv     - ensuring a set of items are gathered in the ISH and transferred to the inventory of a turtle.
        PutItemsFromTurtle_ASrv     - ensuring a set of items are transferred from the inventory of a turtle to the ISH.

    Furthermore it needs to implement the following additional functions
        GetISHURL                   - provide the base URL of the ISH
--]]

--                _     _ _         __                  _   _
--               | |   | (_)       / _|                | | (_)
--    _ __  _   _| |__ | |_  ___  | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | '_ \| | | | '_ \| | |/ __| |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | |_) | |_| | |_) | | | (__  | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   | .__/ \__,_|_.__/|_|_|\___| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
--   | |
--   |_|

function ItemsAvailableVia_SSrv(queryData)
    --[[
        This sync public service queries an ISH for the availability of items. The ISH and query are specified by the "base" (i.e. "ccwprp://host:port/path")
        and "query" component (i.e. `?itemName=itemCount`) of an URL.

        This service is implemented using the following underlying ISH services
            ItemsAvailableVia_SSrv

        Return value:
                                    - (table)
                success             - (boolean) whether all the queried items are available via the URL

        Parameters:
            queryData               - (table) data about the query
                queryItemsLocator   - (URL) stating the items availability that needs to be queried
                                        (the "base" component of the URL specifies the ISH to query)
                                        (the "query" component of the URL specifies the items to query for)
    --]]

    -- check input
    if type(queryData) ~= "table" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid queryData") return {success = false} end
    local queryItemsLocator = queryData.queryItemsLocator
    if type(queryItemsLocator) ~= "table" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid queryItemsLocator") return {success = false} end

    -- get ISH
--    corelog.WriteToLog("enterprise_isp: itemQueryURL = "..textutils.serialize(itemQueryURL))
    local host = queryItemsLocator:getHost()
    if type(host) ~= "string" then corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Invalid host") return {success = false} end
--    corelog.WriteToLog("enterprise_isp: host = "..host)

    -- relay to ISH service
    if host == "turtle" then
        return enterprise_turtle.ItemsAvailableVia_SSrv(queryData)
    elseif host == "chests" then
        return enterprise_chests.ItemsAvailableVia_SSrv(queryData)
    else
        corelog.Error("enterprise_isp.ItemsAvailableVia_SSrv: Not implemented for "..host .." ISH.") return {success = false}
    end
end

function TransferItemsFromTo_ASrv(transferData, callback, callbackData)
    --[[
        This async public service relays the transfer of items from an item source to a destination host.

        This service is implemented using the following underlying ISH services
            GetItemsIntoTurtle_ASrv
            PutItemsFromTurtle_ASrv

        Return value:
            nil 

        Async service return value (to callback):
                                        - (table)
                success                 - (boolean) whether the service was executed succesfully
                destinationItemsLocator - (URL) stating the final ISH and the items that where transferred to it
                                            (upon service succes the "host" component of this URL should be equal to destinationHostLocator, and
                                            the "query" should be equal to the "query" component of the sourceItemsLocator)

        Parameters:
            transferData                - (table) data about the transfer
                sourceItemsLocator      - (URL) stating where the items that need transfer can be located 
                                            (the "query" component of the URL specifies the items to be transferred)
                                            (the "host" component of the URL specifies the host where the items are located)
                destinationHostLocator  - (URL) stating where the items need to be transferred to
            callback                    - (string) name of function to call once service is ready
            callbackData                - (table) data to supply to callback function            
    --]]

    -- check input
    if type(transferData) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid transferData") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local sourceItemsLocator = url.URLClass:new(transferData.sourceItemsLocator)
    if type(sourceItemsLocator) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid sourceItemsLocator") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local destinationHostLocator = url.URLClass:new(transferData.destinationHostLocator)
    if type(destinationHostLocator) ~= "table" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid destinationHostLocator") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    if type(callback) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Invalid callback function.") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    callbackData = callbackData or {}

    -- determine source enterprise name
    local sourceHost = sourceItemsLocator:getHost()
    if type(sourceHost) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: sourceHost of wrong type = "..type(sourceHost)..".") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local sourceEnterprise = nil
    if sourceHost == "turtle" then
        sourceEnterprise = "enterprise_turtle"
    elseif sourceHost == "chests" then
        sourceEnterprise = "enterprise_chests"
    else
        corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Not implemented for "..sourceHost .." source ISH.") return coreutils.DoCallback(callback, callbackData, {success = false})
    end

    -- determine destination enterprise name
    local destinationHost = destinationHostLocator:getHost()
    if type(destinationHost) ~= "string" then corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: destinationHost of wrong type = "..type(destinationHost)..".") return coreutils.DoCallback(callback, callbackData, {success = false}) end
    local destinationEnterprise = nil
    if destinationHost == "turtle" then
        destinationEnterprise = "enterprise_turtle"
    elseif destinationHost == "chests" then
        destinationEnterprise = "enterprise_chests"
    else
        corelog.Error("enterprise_isp.TransferItemsFromTo_ASrv: Not implemented for "..destinationHost .." destination ISH.") coreutils.DoCallback(callback, callbackData, {success = false})
    end

    -- create project definition
    local transferItemsProject = {
        services    = {
            { serviceName = sourceEnterprise..".GetItemsIntoTurtle_ASrv", async = true, input = {
                { keyName = "sourceItemsLocator"        , valueSource = 0, sourceKey = "sourceItemsLocator" },
            }},
            { serviceName = destinationEnterprise..".PutItemsFromTurtle_ASrv", async = true, input = {
                { keyName = "turtleItemsLocator"        , valueSource = 1, sourceKey = "turtleItemsLocator" },
                { keyName = "destinationHostLocator"    , valueSource = 0, sourceKey = "destinationHostLocator" },
            }},
            { serviceName = "enterprise_projects.AreAllTrue_QSrv", async = false, input = {
                { keyName = "success1"                  , valueSource = 1, sourceKey = "success" },
                { keyName = "success2"                  , valueSource = 2, sourceKey = "success" },
            }},
        },
        returnData  = {
            { keyName = "success"                       , valueSource = 3, sourceKey = "success" },
            { keyName = "destinationItemsLocator"       , valueSource = 2, sourceKey = "destinationItemsLocator" },
        }
    }
    local projectData = {
        sourceItemsLocator      = sourceItemsLocator,
        destinationHostLocator  = destinationHostLocator,
    }
    local serviceData = {
        projectDefinition   = transferItemsProject,
        projectInputData    = projectData,
    }

    -- start project
    corelog.WriteToLog(">Transferring items from "..sourceItemsLocator:getURI().." to "..destinationHostLocator:getURI()..".")
    enterprise_projects.StartProject_ASrv(serviceData, callback, callbackData)

    -- end
    return nil
end

--    _                 _    __                  _   _
--   | |               | |  / _|                | | (_)
--   | | ___   ___ __ _| | | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | |/ _ \ / __/ _` | | |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | | (_) | (_| (_| | | | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   |_|\___/ \___\__,_|_| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
