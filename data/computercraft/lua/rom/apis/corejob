local db = {}

function Init()
end

function Setup()
end

function NewJob(name, data, location, startTime, needTool, needTurtle)
    -- parameters controleren
    startTime = startTime or coreutils.UniversalTime()

    -- opslaan
    coredht.SaveData({
        name            = name,
        data            = data,
        location        = location,
        startTime       = startTime,
        needTool        = needTool,
        needTurtle      = needTurtle,
        applications    = {},
    }, "vacancies", coreutils.NewId())
end

function ApplyToJob(jobId)
    -- onzelf toevoegen aan de lijst met inschrijvingen
    coredht.SaveData({
        time            = coreutils.UniversalTime(),
        dice            = math.random(),
    }, "vacancies", jobId, "applications", jobId)
end

function Run()
    -- is de dth al beschikbaar?
    while not coredht.IsReady() do

        -- gewoon ff wachten
        os.sleep(0.25)
    end

    -- bestaat de entry al in de dht?
    if not coredht.GetData("vacancies") then coredht.SaveData({}, "vacancies" ) end

    -- dit blijven we altijd doen
    while core.IsSystemRunning() do

        -- we zijn nu werkeloos
        local nextJobId = nil

        -- volgende job zoeken
        local jobApplication = FindBestVacancy()

        -- hebben we een job?
        if jobApplication then

            -- inschrijven
            corejob.ApplyToJob(jobApplication)

            -- ff wachten, wellicht hebben meer zich ingeschreven
            os.sleep(0.25)

            -- controle wie de job krijgt
            nextJobId = JobSelectionProcedure(jobApplication)
        end

        -- hebben we iets? Zou raar zijn als het niet zo is
        if nextJobId then

            -- we weten nu welke rol we nu moeten doen
            local nextJob   = coredht.GetData("vacancies", nextJobId)

            -- zou raar zijn als we niks gevonden hebben, maar goed
            if nextJob and nextJob.name then

                -- deze job uit de lijst halen, mogen wij doen omdat wij nu deze job hebben
                coredht.SaveData(nil, "vacancies", nextJobId)

                -- juiste job starten
                local f, err = loadstring("role_"..nextJob.name..".Execute("..textutils.serialize(nextJob.data)..")")

                -- valid function?
                if f then f() else coreutils.Error("corejob.Run(): loadstring gaf geen functie terug, wel een error: "..err) end
            else
                -- dit is niet best
                coreutils.Error("corejob.Run(): Job "..nextJobId.." is niet gevonden in de vacancies lijst")
            end
        else
            -- blijkbaar is er geen werk op dit moment
            os.sleep(0.25)
        end
    end
end

function FindBestVacancy()
    -- zoeken naar een job om op in te schrijven
    local vacancies = coredht.GetData("vacancies")

    -- kijken of we een lege lijst hebben gekregen?
    if not vacancies then return nil end

    -- op zoek naar de beste job
    for jobId, jobData in pairs(vacancies) do

        -- de eerste de beste
        return jobId
    end

    -- niks gevonden
    return nil
end

function JobSelectionProcedure(jobId)
    -- data van de job ophalen
    local jobData = coredht.GetData("vacancies", jobId, "applications")

    -- dit lijkt mij wel iets voor ons!
    if jobData  then return jobId
                else return nil end

end
