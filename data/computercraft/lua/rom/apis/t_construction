local testStartLocation  = {x= 0, y= 0, z= 1, dx=0, dy=1}
local testStartLocation2  = {x= 6, y= 0, z= 1, dx=0, dy=1}

local testBuildPattern1 = {
    deltaX      = 4,
    deltaY      = 6,
    objectList  = {
        { x = 0, y = 3,                 block = "minecraft:torch"},
        { x = 2, y = 5, dx = 0, dy = 1, block = "minecraft:chest"},
        { x = 3, y = 0,                 block = "minecraft:torch"},
    },
    clearRemainingSpace = true,
}

local testBuildPattern2 = {
    deltaX      = 3,
    deltaY      = 3,
    objectList  = {
        { x = 0, y = 0, dx =-1, dy = 0, block = "minecraft:chest"},
        { x = 0, y = 1, dx =-1, dy = 0, block = "minecraft:chest"},

        { x = 0, y = 2, dx = 0, dy = 1, block = "minecraft:chest"},
        { x = 1, y = 2, dx = 0, dy = 1, block = "minecraft:chest"},

        { x = 1, y = 0, dx = 0, dy =-1, block = "minecraft:chest"},
        { x = 2, y = 0, dx = 0, dy =-1, block = "minecraft:chest"},

        { x = 2, y = 1, dx = 1, dy = 0, block = "minecraft:chest"},
        { x = 2, y = 2, dx = 1, dy = 0, block = "minecraft:chest"},
    },
    clearRemainingSpace = true,
}

local testBuildPattern3 = {
    deltaX      = 6,
    deltaY      = 6,
    objectList  = {
        { x = 0, y = 3,                 block = "minecraft:torch"},
        { x = 2, y = 5, dx = 0, dy = 1, block = "minecraft:chest"},
        { x = 3, y = 0,                 block = "minecraft:torch"},
        { x = 4, y = 5, dx = 0, dy = 1, block = "minecraft:chest"},
    },
    clearRemainingSpace = true,
}

local testBuildPattern4 = {
    deltaX      = 1,
    deltaY      = 1,
    objectList  = {
    },
    clearRemainingSpace = true,
}

local testBlueprint1 = {
    layerList = {
        { startpoint = { x= 0, y= 0, z=  0}, buildFromAbove  = true, pattern = testBuildPattern3},
        { startpoint = { x= 3, y= 3, z= -1}, buildFromAbove  = false, pattern = testBuildPattern4},
        { startpoint = { x= 2, y= 2, z= -2}, buildFromAbove  = false, pattern = testBuildPattern2},
        { startpoint = { x= 2, y= 2, z= -3}, buildFromAbove  = false, pattern = role_builder.CopyPattern(testBuildPattern2)}
    },
    escapeSequence = {
        { x= 3, y= 3, z=  1},
    }
}

local testBlueprint2 = {
    layerList = {
        { startpoint = { x= 0, y= 0, z=  0}, buildFromAbove  = true, pattern = testBuildPattern1},
        { startpoint = { x= 3, y= 3, z= -1}, buildFromAbove  = false, pattern = testBuildPattern2},
    },
    escapeSequence = {
        { x= 3, y= 3, z=  1},
    }
}

function T_BuildRectangularPattern_FromTurtle()
    -- test service 1
    corelog.WriteToLog("# Test BuildRectangularPattern_ASrv (from turtle)")
    local buildData = {
        startpoint = testStartLocation,
        buildFromAbove = true,
        pattern = testBuildPattern1,
        materialsHostLocator = enterprise_turtle.GetISHURL_SSrv({ }).url
    }
    local callbackFunction = "t_main.Func1_Callback"
    local callbackData = {"some callback data"}

    corelog.WriteToLog("T_construction calling BuildRectangularPattern_ASrv("..textutils.serialise(buildData)..", "..callbackFunction..")")
    enterprise_construction.BuildRectangularPattern_ASrv(buildData, callbackFunction, callbackData)
end

function T_BuildRectangularPattern_FromChest()
    -- test service 
    corelog.WriteToLog("# Test BuildRectangularPattern_ASrv (from chest)")

    -- create project definition
    local buildRectangularPattern_ASrvProject = {
        services    = {
            -- preparation
            { serviceName = "enterprise_projects.StartProject_ASrv", async = true, input = {
                { keyName = "projectDefinition"         , valueSource = 0, sourceKey = "projectDefinition" },
                { keyName = "projectInputData"          , valueSource = 0, sourceKey = "projectInputData" },
            }},
            { serviceName = "enterprise_chests.GetChestLocator_SSrv", async = false, input = {
                { keyName = "id"                        , valueSource = 1, sourceKey = "id" },
            }},

            -- BuildRectangularPattern_ASrv
            { serviceName = "enterprise_construction.BuildRectangularPattern_ASrv", async = true, input = {
                { keyName = "startpoint"                , valueSource = 0, sourceKey = "startpoint" },
                { keyName = "buildFromAbove"            , valueSource = 0, sourceKey = "buildFromAbove" },
                { keyName = "pattern"                   , valueSource = 0, sourceKey = "pattern" },

                { keyName = "materialsHostLocator"     , valueSource = 2, sourceKey = "url" },
            }},

            -- cleanup
            { serviceName = "enterprise_chests.DelistChest_ASrv", async = true, input = {
                { keyName = "id"                        , valueSource = 1, sourceKey = "id" },
            }},

            -- wrap-up
            { serviceName = "enterprise_projects.AreAllTrue_QSrv", async = false, input = {
                { keyName = "success1"                  , valueSource = 1, sourceKey = "success" },
                { keyName = "success2"                  , valueSource = 2, sourceKey = "success" },
                { keyName = "success3"                  , valueSource = 3, sourceKey = "success" },
                { keyName = "success4"                  , valueSource = 4, sourceKey = "success" },
            }},
        },
        returnData  = {
            { keyName = "success", valueSource = 5, sourceKey = "success" },
        }
    }
    local serviceData = {
        projectDefinition = buildRectangularPattern_ASrvProject,
        projectInputData = {
            -- chest
            projectDefinition   = t_chests.GetRegisterAndUpdateChestProject(),
            projectInputData    = {
                chestLocation        = {x= 2, y= 5, z= 1, dx=0, dy=1},
                chestAccessDirection = "top",
            },

            -- build data
            startpoint          = testStartLocation2,
            buildFromAbove      = true,
            pattern             = testBuildPattern1,
        },
    }

    -- start project
    local callbackFunction = "t_main.Func1_Callback"
    local callbackData = {"some callback data"}
    enterprise_projects.StartProject_ASrv(serviceData, callbackFunction, callbackData)
end

function T_BuildBlueprint_Service()
    -- test service 2
    corelog.WriteToLog("# Test 2")
    local blueprintBuildData = {blueprintStartpoint = coremove.GetRelativeLocation(testStartLocation, 6, 0, 0), blueprint = testBlueprint1}
    local callbackFunction = "t_main.Func1_Callback"
    local callbackData = {"some callback data"}
    corelog.WriteToLog("T_construction calling BuildBlueprint_ASrv("..textutils.serialise(blueprintBuildData)..", "..callbackFunction..")")
    enterprise_construction.BuildBlueprint_ASrv(blueprintBuildData, callbackFunction, callbackData)
end

function T_role_builder_MetaDatas()
    local buildData = {startpoint = testStartLocation, buildFromAbove = true, pattern = testBuildPattern1}
    local blueprintBuildData = {blueprintStartpoint = coremove.GetRelativeLocation(testStartLocation, 6, 0, 0), blueprint = testBlueprint2}

    corelog.WriteToLog("BuildRectangularPattern_MetaData => "..textutils.serialize(role_builder.BuildRectangularPattern_MetaData(buildData)))
    corelog.WriteToLog("BuildBlueprint_MetaData => "..textutils.serialize(role_builder.BuildBlueprint_MetaData(blueprintBuildData)))
end

function T_BuildRectangularPattern_Task()
    local buildData = {startpoint = testStartLocation, buildFromAbove = true, replacePresentObjects = true, pattern = testBuildPattern1}

    role_builder.BuildRectangularPattern_Task(buildData)
end
