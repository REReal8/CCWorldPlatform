local db = {
    messageList = {}
}

function Init()
end

function Setup()
    -- berichten opslaan die verstuurd zijn voordat de dht klaar is
    coredht.DHTReadyFunction(MessageToDHT)
end

function DHTReadySetup()
    -- kijken of onze key wel bestaat in de dht
    local messages = coredht.GetData("messages")

    -- en, bestaat deze?
    if not messages then coredht.SaveData({}, "messages") end

    -- opslaan in de dht
    MessageToDHT()
end

function SendMessageToId(recipient, message, notBefore)
    -- parameter controle
    notBefore = notBefore or 0

    -- nieuw id aanmaken
    local messageId = coreutils.NewId()

    -- opslaan in de lokale lijst
    db.messageList[ messageId ] = {
        recipient   = recipient,
        time        = coreutils.UniversalTime(),
        notBefore   = notBefore,
        data        = message,
    }

    -- opslaan in de dht
    MessageToDHT()
end

function GetNextMessage(recipient)
    -- hoe laat is het eigenlijk
    local nu = coreutils.UniversalTime()
    local firstTime = nu + 1
    local messageId   = nil

    -- lekker zoeken
    local messages  = coredht.GetData("messages")

    -- door alle berichten lopen
    for id, message in pairs(messages) do

        -- is dit een beter bericht?
        if recipient == message.recipient and firstTime > message.time and nu >= message.notBefore then firstTime = message.time messageId = id end
    end

    -- hebben we iets?
    if messageId then
        -- uit de lijst halen en terug geven
        local message = messages[ messageId ].data

        -- uit de dht halen
        coredht.SaveData(nil, "messages", messageId)

        -- klaar
        return message
    else
        -- geen bericht gevonden blijkbaar
        return nil
    end
end

--    _                 _    __                  _   _
--   | |               | |  / _|                | | (_)
--   | | ___   ___ __ _| | | |_ _   _ _ __   ___| |_ _  ___  _ __  ___
--   | |/ _ \ / __/ _` | | |  _| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
--   | | (_) | (_| (_| | | | | | |_| | | | | (__| |_| | (_) | | | \__ \
--   |_|\___/ \___\__,_|_| |_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
--
--

function MessageToDHT()
    -- only if the dht is ready
    if coredht.IsReady() then

        -- alle berichten langs lopen
        for id, message in pairs(db.messageList) do

            -- opslaan in de dht
            coredht.SaveData(message, "messages", id)
        end

        -- lijst leeg maken
        db.messageList = {}
    end
end