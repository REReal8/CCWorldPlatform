local testStartLocation  = {x= -6, y= 0, z= 1, dx=0, dy=1}
local testStartLocation2  = {x= -6, y= 6, z= 1, dx=0, dy=1}
local itemQuery = {
    ["minecraft:birch_log"] = 3,
    ["minecraft:torch"]     = 5,
}

local storageURI = "ccwprp://storage"
local queryPartURI = "?minecraft:birch_log=1&minecraft:torch=5"
local storageQueryURI = storageURI.."/site=2/outputchest=4/"..queryPartURI
local factoryInputChestURI = "ccwprp://factory/site=3/inputchest=2"
local factoryOutputChestURI = "ccwprp://factory/site=3/ouputchest=1"

local callbackFunction = "t_main.Func1_Callback"
local callbackData = {"some callback data"}

function T_TransferItemsFromTo_Chests()
    corelog.WriteToLog("* Test TransferItemsFromTo_ASrv between chests:")

    -- create project definition
    local transferItemsBetweenChestsProjectDef = {
        steps   = {
            -- preparation
            { stepName = "enterprise_projects.StartProject_ASrv", async = true, stepDataDef = {
                { keyDef = "projectDef"             , valueSource = 0, keyDefSource = "projectDef1" },
                { keyDef = "projectData"            , valueSource = 0, keyDefSource = "projectData1" },
            }},
            { stepName = "enterprise_chests.GetItemLocator_SSrv", async = false, stepDataDef = {
                { keyDef = "id"                     , valueSource = 1, keyDefSource = "id" },
                { keyDef = "itemQuery"              , valueSource = 0, keyDefSource = "itemsToTransferQuery" },
            }},
            { stepName = "enterprise_projects.StartProject_ASrv", async = true, stepDataDef = {
                { keyDef = "projectDef"             , valueSource = 0, keyDefSource = "projectDef2" },
                { keyDef = "projectData"            , valueSource = 0, keyDefSource = "projectData2" },
            }},
            { stepName = "enterprise_chests.GetChestLocator_SSrv", async = false, stepDataDef = {
                { keyDef = "id"                     , valueSource = 3, keyDefSource = "id" },
            }},

            -- TransferItemsFromTo_ASrv
            { stepName = "enterprise_isp.TransferItemsFromTo_ASrv", async = true, stepDataDef = {
                { keyDef = "sourceItemsLocator"     , valueSource = 2, keyDefSource = "url" },
                { keyDef = "destinationHostLocator" , valueSource = 4, keyDefSource = "url" },
            }},

            -- cleanup
            { stepName = "enterprise_chests.DelistChest_ASrv", async = true, stepDataDef = {
                { keyDef = "id"                     , valueSource = 1, keyDefSource = "id" },
            }},
            { stepName = "enterprise_chests.DelistChest_ASrv", async = true, stepDataDef = {
                { keyDef = "id"                     , valueSource = 3, keyDefSource = "id" },
            }},

            -- wrap-up
            { stepName = "enterprise_projects.AreAllTrue_QSrv", async = false, stepDataDef = {
                { keyDef = "success1"               , valueSource = 1, keyDefSource = "success" },
                { keyDef = "success2"               , valueSource = 2, keyDefSource = "success" },
                { keyDef = "success3"               , valueSource = 3, keyDefSource = "success" },
                { keyDef = "success4"               , valueSource = 4, keyDefSource = "success" },
                { keyDef = "success5"               , valueSource = 5, keyDefSource = "success" },
                { keyDef = "success6"               , valueSource = 5, keyDefSource = "success" },
                { keyDef = "success7"               , valueSource = 5, keyDefSource = "success" },
            }},
        },
        returnData  = {
            { keyDef = "success"                    , valueSource = 8, keyDefSource = "success" },
            { keyDef = "destinationItemsLocator"    , valueSource = 5, keyDefSource = "destinationItemsLocator" },
        }
    }
    local projectServiceData = {
        projectDef  = transferItemsBetweenChestsProjectDef,
        projectData = {
            -- chest 1
            projectDef1     = t_chests.GetRegisterAndUpdateChestProjectDef(),
            projectData1    = {
--                chestLocation        = {x= 2, y= 5, z= 1, dx=0, dy=1},
                chestLocation        = coremove.GetRelativeLocation(testStartLocation, 2, 5, 0),
                chestAccessDirection = "top",
            },

            -- query
            itemsToTransferQuery = itemQuery,

            -- chest 2
            projectDef2     = t_chests.GetRegisterAndUpdateChestProjectDef(),
            projectData2    = {
--                chestLocation        = {x= 8, y= 5, z= 1, dx=0, dy=1},
                chestLocation        = coremove.GetRelativeLocation(testStartLocation2, 2, 5, 0),
                chestAccessDirection = "back",
            },

        },
    }

    -- start project
    enterprise_projects.StartProject_ASrv(projectServiceData, callbackFunction, callbackData)
end

function T_ISPUsingProject()
    -- create project definition
    local projectData = {
        sourceItemsLocator = url.URLClass:newFromURI(storageQueryURI),
        localInputHostLocator = url.URLClass:newFromURI(factoryInputChestURI),
        localOutputItemsLocation = url.URLClass:newFromURI(factoryOutputChestURI),
        destinationHostLocator = url.URLClass:newFromURI(storageURI)
     }
    local aTypicalServiceUsingItemsProjectDef = {
        steps   = {
            { stepName = "enterprise_isp.TransferItemsFromTo_ASrv", async = true, stepDataDef = {
                { keyDef = "sourceItemsLocator"     , valueSource = 0, keyDefSource = "sourceItemsLocator" },
                { keyDef = "destinationHostLocator" , valueSource = 0, keyDefSource = "localInputHostLocator" },
            }},

            -- other services (that e.g. could require items in a turtle's iventory) to implement the typical service

            { stepName = "enterprise_isp.TransferItemsFromTo_ASrv", async = true, stepDataDef = {
                { keyDef = "sourceItemsLocator"     , valueSource = 0, keyDefSource = "localOutputItemsLocation" },
                { keyDef = "destinationHostLocator" , valueSource = 0, keyDefSource = "destinationHostLocator" },
            }},
            { stepName = "enterprise_projects.AreAllTrue_QSrv", async = false, stepDataDef = {
                { keyDef = "success1"               , valueSource = 1, keyDefSource = "success" },
                { keyDef = "successN"               , valueSource = 2 --[[ likely higher]], keyDefSource = "success" },
            }},
        },
        returnData  = {
            { keyDef = "success"                    , valueSource = 3 --[[ likely higher]], keyDefSource = "success" },
        }
    }
    local projectServiceData = {
        projectDef  = aTypicalServiceUsingItemsProjectDef,
        projectData = projectData,
    }

    -- call test method
    enterprise_projects.StartProject_ASrv(projectServiceData, callbackFunction, callbackData)
end
